from others.tokenization import BertTokenizer
import torch
from models import data_loader
from models.model_builder import ExtSummarizer
from models.trainer_ext import build_trainer

model_flags = ['hidden_size', 'ff_size', 'heads', 'inter_layers', 'encoder', 'ff_actv', 'use_interval', 'rnn_size']

text = '''
The Vanguard Consumer Staples Index ETF (NYSEARCA: VDC ) offers investors targeted exposure to stocks in one of the core market sectors through a low-cost diversified exchange-traded fund. Given the ongoing coronavirus pandemic, consumer staples have represented a defensive position for many investors, considering many companies benefited from consumers stocking up on items during worldwide lockdown measures. At the same time, other companies in the group with broader exposure beyond household essentials have had their business disrupted with parts of the economy shut down. We take a more cautious outlook on the fund and highlight some weaker growth trends and valuation concerns among some of the top holdings that now represent headwinds from current levels. (Source: finviz.com) VDC Background The VDC ETF with $5.8 billion in total assets and 92 underlying holdings tracks the "MSCI US IMI Consumer Staples Index". The index and fund are cap-weighted and include U.S. large, mid, and small-cap consumer staples companies that represent a passive approach to capture sector trends. (Source: Vanguard ) Consumer staples typically refer to goods that are considered essential or at least a recurring part of consumer spending budgets. It's understood that these companies are less exposed to the economic cycle as consumers in a recession would still require food and beverages, household and personal items, along with resilient demand for alcohol and tobacco. Companies like Procter & Gamble (NYSE: PG ) and PepsiCo Inc. (NASDAQ: PEP ), among the top 3 holdings, are representative of the classic staples stock. The classifications have some subjectivity with some companies featuring different products and business models that may fall into the discretionary category. An example here is Walmart Inc. (NYSE: WMT ) and Costco Wholesale Corp. (NASDAQ: COST ), which are the 4th and 5th largest holdings, with combined a 14% weighting in the fund. While these retailers specialize in everyday consumer items, some products at their stores like electronics, clothing, toys, and jewelry, for example, can face varying demand trends depending on economic conditions. Individual stocks within the group will also trade based on various company-specific or industry trends. VDC Performance One of the features of the consumer staples sector and the VDC ETF is the relatively high concentration among the top holdings. The top 5 stocks, including PG, PEP, WMT, COST, and also Coca-Cola Co. (NYSE: KO ), together represent nearly 48% of the entire fund. This is a function of the market-cap weighting methodology and consistent with the importance of these companies. This means that the performance of these stocks will drive returns for the entire sector and ETF. VDC has declined about 9% year to date in 2020, which includes the period of extreme volatility in March along with a more recent rebound. From the market lows in late March, VDC is up 18%. The current ETF share price at $146 is a level the fund first traded at back in early 2018, highlighting what has been relatively flat returns over the period, although trading in a wide range. Data by YCharts This year has been defined by the ongoing coronavirus pandemic, which introduced some unique dynamics that have impacted consumer staple companies differently. Among the underlying holdings, we find a dispersion of returns this year and continued volatility. There have been some obvious winners in the "stay-at-home" trend, with consumers stocking up on household essentials and groceries, given global quarantine measures. A big winner has been Clorox Company (NYSE: CLX ) with its vast line of disinfecting products that are also used at the industrial scale by corporate customers and public agencies. CLX is up 34% year to date. Packaged foods giant General Mills Inc. (NYSE: GIS ) and grocery store chain The Kroger Co. (NYSE: KR ) are each up 14% year to date as beneficiaries from the consumer lockdowns. (Source: data by YCharts/ table by author) Still, there were some losers, particularly those companies that were disrupted by the shutdown of restaurants and other public spaces. Coca-Cola, as the world's largest beverage company, is down 17% and representing 10% of the VDC lost significant global sales as dining out options and large scale venues where consumers typically enjoy soft drinks have been forced to close. Sysco Corp. (NYSE: SYY ) has been one of the weakest stocks in the group down 40% this year as a large portion of the business supplies the restaurant industry with key cooking ingredients. Analysis and Forward-Looking Commentary The pandemic has represented a historic level of economic disruption that makes the medium-term outlook for all companies particularly uncertain. On one hand, the consensus is that the enormous level of relief measures between the Fed and U.S. government is likely to mitigate many of the near-term consequences of the economic shutdown. Generous unemployment benefits and wide-reaching federally-backed loan programs can keep businesses afloat during the most challenging period before conditions can normalize. Still, weaker consumer incomes can represent a challenge for consumer staples, even if they are more resilient compared to discretionary purchases. The other side to that is the potential that some of the damages to the economy are not temporary especially as it relates to the labor market. A level of structurally higher unemployment through 2021 represents one of the major risk factors facing the economic recovery and the outlook for consumer staples. If more people are unemployed, consumer spending will be pressured representing growth headwinds. There is also a dynamic where some stocks within VDC have been bid up based on a potentially only-temporary windfall of strong trends during the initial stages of the pandemic. As the economy begins to reopen, and consumers no longer need to hoard household essentials, companies like General Mills ( GIS ) and Kimberly-Clark (NYSE: KMB ) could have a weaker second half of the year as consumers go through personal inventories. Keep in mind that this is a global crisis, and most of the consumer staples companies in VDC generate significant levels of revenue and operating income from international markets, meaning they are exposed to broad macro trends. We also expect that the recovery in foreign countries where consumer staples companies do business will be weaker as many cannot afford the same level of stimulus measures offered in the United States. Stretched Valuation The appearance right now with the fund down just 9% in 2020 is that the market is taking a glass-half-full type of approach, giving consumer staples a benefit of the doubt. We are more skeptical and note that many key stocks are trading near their all-time high despite the higher risks. Procter & Gamble represents 15% of the fund as the largest holding and is a good example of what we see as stretched valuations. Data by YCharts The stock trades at a price to sales multiple of 4.2x, which has climbed steadily over the past decade. This compares to a 10-year average P/S for the stock at 3.2x, implying investors are paying 31% more for every dollar the company generates in revenue. Separately, PG is also trading a forward price to earnings multiple of 22.8x compared to a 10-year average of 20.8x. By this measure, the stock is 10% overvalued. This dynamic applies to the other top holdings in the fund that trades at a relatively wide premium compared to long term P/E averages. 10% (Source: data by YCharts/table by author) We argue that heading into a recessionary environment, most stocks should not trade at a premium to levels from the prior bull market. Our expectation is for all companies to see weaker growth and earnings trends through 2021. At the ETF level, we note that VDC's dividend yield of 2.6% compares to the S&P 500 (NYSEARCA: SPY ) at 2.0%. Again, we think the yield should be wider to compensate for the higher risks as another bearish factor. Data by YCharts Verdict Consumer staples benefited as a defensive trade during the early stages of the pandemic with several companies benefiting from trends in household spending. We think investors should look out through 2021 and discount the higher level of uncertainties, with weaker trends in growth representing a downside risk for the group and the VDC ETF. VDC is a good option to capture passive exposure to sector trends in a low-cost ETF with an expense ratio of just 0.1%. That being said, we are on the sidelines of this group and think patient investors can find a better entry point later this year. The following factors summarize the risks and bearish case for the VDC ETF. Are you interested to learn how this idea can fit within a diversified portfolio? With the Core-Satellite Dossier marketplace service, we sort through +4,000 ETFs/CEFs along with +16,000 U.S. stocks/ADRs to find the best trade ideas. Click here for a two-week free trial and explore our content. Disclosure: I/we have no positions in any stocks mentioned, and no plans to initiate any positions within the next 72 hours. I wrote this article myself, and it expresses my own opinions. I am not receiving compensation for it (other than from Seeking Alpha). I have no business relationship with any company whose stock is mentioned in this article.'''

def test_text_ext(args):
    checkpoint = torch.load(args.test_from, map_location=lambda storage, loc: storage)
    opt = vars(checkpoint['opt'])
    for k in opt.keys():
        if (k in model_flags):
            setattr(args, k, opt[k])

    device = "cpu" if args.visible_gpus == '-1' else "cuda"
    device_id = 0 if device == "cuda" else -1

    model = ExtSummarizer(args, device, checkpoint)
    model.eval()

    text = args.text
    do = True
    # python train.py -text_src ../raw_data/temp_ext.raw_src -test_from ../models/bertext.pt
    while do: 
        test_iter = data_loader.load_text(args, text, args.text_tgt, device)
        trainer = build_trainer(args, device_id, model)
        result = trainer.test(test_iter, -1)
        tokenizer = BertTokenizer.from_pretrained('bert-base-uncased', do_lower_case=True)
        text = ' '.join(result)
        if(len(tokenizer.tokenize(text)) < 250):
            do = False

    print(text)


